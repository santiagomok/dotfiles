# ------------------------------------------------------------------------------
# File: tmux.conf
# ------------------------------------------------------------------------------
#
# Based on 
# - https://github.com/samoshkin/tmux-config 
# - https://github.com/henrik/dotfiles.git
# - https://github.com/dminca/dotfiles.git

# ------------------------------------------------------------------------------

# General
set -g history-limit 20000
set -g buffer-limit 20
set -g display-time 1500
set -sg escape-time 0 # See if this fixes slow ESC issues.
set-option -g mouse on # Enable mouse scrolling 

setw -g mode-keys vi # Use vim keybindings in copy mode | http://robots.thoughtbot.com/tmux-copy-paste-on-os-x-a-better-future
set -g xterm-keys on # Make shift+arrows, ctrl+arrows etc work in Vim.
set-window-option -g xterm-keys on # Fix ctrl+left/right keys work right


# ------------------------------------------------------------------------------

# Display

# Colour Table
# colour0   : black
# colour15  : white

#run-shell "powerline-daemon-q"
#source ${HOME}/.local/lib/python3.6/site-packages/powerline/bindings/tmux/powerline.conf 

if-shell "test -f ~/.tmux/theme_iceberg.conf" "source ~/.tmux/theme_iceberg.conf"
# Set parent terminal title to reflect current window in tmux session
set -g default-terminal "screen-256color"
set -g set-titles on
set -g set-titles-string "#h | #S | #I:#W"

# Status bar styling and content.
#set -g status-bg grey
#set -g status-fg white
#set -g status-left ' #S '
# Panes
# set -g pane-border-bg colour0
# set -g pane-border-fg colour6
# set -g pane-active-border-bg colour0
#set -g pane-active-border-fg colour12

set-option -g status-position bottom
set -g base-index 1 # window index start at 1
set -g pane-base-index 1 # pane index start at 1

# Show keyboard layout in prompt, assuming some script writes it to that path;
# it's "/User/…" instead of "~" so VMs can read from their symlinked OS X host home directory.
#set -g status-right ' | #h | %H:%M %m-%d-%y'
#set -g status-right-length 120
#set -g status-interval 2

# Highlight the active window in the status bar.
#set-window-option -g window-status-current-bg green 
#set-window-option -g window-status-current-fg black


# ------------------------------------------------------------------------------
# Key Bindings
#
# Unbind default key bindings to be overriden
unbind-key "\$" # rename-session
unbind-key ,    # rename-window
unbind-key %    # split-window horizontal
unbind-key '"'  # split-window vertical
unbind-key &    # kill-window
unbind-key =    # choose buffer
unbind-key n    # next-window
unbind-key p    # previous-window
unbind-key r    # force rdraw of attached client

# Switch pane
unbind-key Up
unbind-key Down
unbind-key Left
unbind-key Right

# Resize the current pane in steps of one cell
unbind-key C-Up     
unbind-key C-Down
unbind-key C-Left
unbind-key C-Right

# Default key bindings
# bind-key C-b  # leader key
# bind-key ?    # List all key bind-keyings
# bind-key !    # Break the current pane out to a new window
# bind-key .    # Prompt for an index to move current window
# bind-key 0-9  # Select windows index #
# bind-key z    # zoom pane

# Edit ~/.tmux.conf and reload
bind-key C-e new-window -n 'tmux.conf' "sh -c '\${EDITOR:-vim} ~/.tmux.conf && tmux source ~/.tmux.conf && tmux display \"Reloaded config.\"'"

# Reload ~/.tmux.conf
bind-key r source-file ~/.tmux.conf \; display "Reloaded config." 

bind-key c new-window -c '#{pane_current_path}' # new-window and retain cwd

bind-key C-r command-prompt -I "#{window_name}" "rename-window '%%'"
bind-key R command-prompt -I "#{session_name}" "rename-session '%%'"
bind-key _ split-window -v -c '#{pane_current_path}' # split-window horizontal
bind-key | split-window -h -c '#{pane_current_path}' # split-window vertical

# Select panes and windows
bind-key -r C-[ previous-window
bind-key -r C-] next-window
bind-key -r [ select-pane -t :.-
bind-key -r ] select-pane -t :.+
bind-key -r Tab last-window     # Cycle thru MRU tabs
bind-key -r C-o swap-pane -D    # -D: swaps with next pane (numerically)     
bind-key -r M-o swap-pane -U    # -U: swap with preivous pane (numerically)

# Swap panes back and forth with 1st pane
# When in main-(horizontal|vertical) layouts, the biggest/widest panel is always @1
bind-key \ if '[ #{pane_index} -eq 1 ]' \
        'swap-pane -s "!"' \
        'select-pane -t:.1 ; swap-pane -d -t 1 -s "!"'

# vim-like pane resizing
bind-key -r K resize-pane -U 5
bind-key -r J resize-pane -D 5
bind-key -r H resize-pane -L 5
bind-key -r L resize-pane -R 5

# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind-key -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind-key -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind-key -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"
bind-key -n C-\ if-shell "$is_vim" "send-keys C-\\" "select-pane -l"
bind-key -T copy-mode-vi C-h select-pane -L
bind-key -T copy-mode-vi C-j select-pane -D
bind-key -T copy-mode-vi C-k select-pane -U
bind-key -T copy-mode-vi C-l select-pane -R
bind-key -T copy-mode-vi C-\ select-pane -l

# Link window
#bind-key / command-prompt -p "Link window from (session:window): " "link-window -s %% -a"

# Kill pane/window/session
bind-key x kill-pane # don't prompt
bind-key X kill-window # don't prompt
bind-key C-x confirm-before -p "kill other windows? (y/n)" "kill-window -a"
bind-key Q confirm-before -p "kill-session #s? (y/n)" kill-session

# Detach
bind-key d detach
bind-key D if -F '#{session_many_attached]' \
        'confirm-before -p "Detach other clients? (y/n)" "detach -a"' \
        'display "Session has only 1 client attached"'

# ------------------------------------------------------------------------------

# Window monitoring for activity and silence 

bind-key m setw monitor-activity \; display-message 'Monitor window activity [#{?monitor-activity,ON,OFF}]'
bind-key M if -F '#{monitor-silence}' \
        'setw monitor-silence 0 ; display-message "Monitor window silence [OFF]"' \
        'command-prompt -p "Monitor silence: interval (s)" "setw monitor-silence %%"'

# Activity bell and whistles
set -g visual-activity on

# TODO: Does not work as well, check on newer versions
# set -g visual-silence on

# BUG: bell-action other ignored · Issue #1027 · tmux/tmux · GitHub - https://github.com/tmux/tmux/issues/1027
# set -g visual-bell on
# setw -g bell-action other
# --------------------------------------
# Copy and Paste
# --------------------------------------

# https://github.com/samoshkin/tmux-config
# ANSI 52 OSC use to copy between local and remote tmux session
# yank="~/.local/bin/yank.sh"
# <leader> Alt+v to start copy mode
# 'v' to begin selection as in Vim
bind-key M-v copy-mode
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection
bind-key -T copy-mode-vi Y send-keys -X copy-pipe-and-cancel "xclip -i -f -selection primary | xclip -i -selection clipboard"
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "xclip -i -f -selection primary | xclip -i -selection clipboard"
#bind-key -T copy-mode-vi Y send-keys -X copy-pipe-and-cancel "$yank"

# Copy selection on mouse drag event
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe "xclip -i -f -selection primary | xclip -i -selection clipboard"

# Paste
bind-key p paste-buffer
bind-key C-p choose-buffer

# Default is clipboard external
# set-clipboard on|external

# Unbork my iTerm ctrl+1 etc mappings in tmux 2.1
# https://github.com/tmux/tmux/issues/159
#set -g assume-paste-time 0


